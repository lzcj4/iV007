<html>
<head>
    <meta name="viewport" content="width=device-width">
    {% load static %}
    <script src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
    <script src="{% static 'js/socket.io.js' %}"></script>
    <style>
        canvas {
            border: 1px solid transparent;
            position: absolute;
        }
    </style>
</head>

<body>

<div style="position:relative">
    <div style="position:absolute;left:0;top:0;z-index: 2" id="divCanvas">
    </div>

    <div style="position:absolute;left:0;top:0">
        <video controls autoplay id="videoplayer">
            <source src="{% static 'video/test1.mp4' %}" type="video/mp4">
        </video>
    </div>
</div>

<script>
    function Dictionary() {
        var items = {};

        this.has = function (key) {
            return key in items;
        };

        this.put = function (key, value) {
            items[key] = value;
        };

        this.remove = function (key) {
            if (this.has(key)) {
                delete items[key];
                return true;
            }
            return false;
        };

        this.get = function (key) {
            return this.has(key) ? items[key] : undefined;
        };

        this.values = function () {
            var values = [];
            for (var k in items) {
                if (this.has(k)) {
                    values.push(items[k]);
                }
            }
            return values;
        };

        this.clear = function () {
            items = {};
        };

        this.size = function () {
            var count = 0;
            for (var prop in items) {
                if (items.hasOwnProperty(prop)) {
                    ++count;
                }
            }
            return count;
        };

        this.getItems = function () {
            return items;
        };
    }

    var dic = new Dictionary();
    var dataList = new Array();

    function mousePosition(ev) {
        var scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft;
        var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        return {
            x: ev.clientX + scrollLeft - document.documentElement.clientLeft,
            y: ev.clientY + scrollTop - document.documentElement.clientTop
        };
    }

    function drawDefaultCanvas() {
        var data = {
            'name': "张三",
            'sex': '男',
            'age': 20,
            'icon': "http://127.0.0.1:8000/static/images/ship.png",
            'x': 10,
            'y': 10,
            'width': 200,
            'height': 200
        }
        createCanvas(data);
    }

    function createCanvas(data) {
        var cvs = dic.get(data.name)
        console.log(data)
        if (cvs != null) {
            cvs.style.left = data.x;
            cvs.style.top = data.y;
            return;
        }
        var canvas = document.createElement("canvas");
        canvas.width = data.width;
        canvas.height = data.height;
        canvas.style.left = data.x;
        canvas.style.top = data.y;
        dic.put(data.name, canvas);

        $('#divCanvas').append(canvas);
        $("#videoplayer").click(function (ev) {
            var pos = mousePosition(ev);
            canvas.style.left = pos.x;
            canvas.style.top = pos.y;
        })
        var ctx = canvas.getContext("2d");
        var img = document.createElement("img");
        img.width = 50;
        img.height = 50;
        img.src = data.icon;
        ctx.strokeStyle = "red";
        ctx.strokeRect(0, 0, 100, 100);
        ctx.drawImage(img, 110, 10);
        ctx.fillStyle = "red"
        ctx.fillText(data.name, 110, 70);
        ctx.fillText(data.sex, 110, 90);
        ctx.fillText(data.age, 110, 110);
        {#        ctx.fillStyle = "#d3d3d3";#}
        ctx.strokeStyle = "red";
        ctx.strokeRect(0, 0, 100, 100);

        {#        ctx.fillStyle = "green";#}
        {#        ctx.fill();#}
        {##}
        {#        ctx.font = "30px Verdana";#}
        {#        // 创建渐变#}
        {#        var gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);#}
        {#        gradient.addColorStop("0", "magenta");#}
        {#        gradient.addColorStop("0.5", "blue");#}
        {#        gradient.addColorStop("1.0", "red");#}
        {#        // 用渐变填色#}
        {#        ctx.fillStyle = gradient;#}
        {#        ctx.fillText("w3school.com.cn", 10, 90);#}
    }

    drawDefaultCanvas();
    var socket = io('http://localhost');
    socket.on('server', function (data) {
        dataList.push(data);
        socket.emit('client', {my: 'data'});
    });
    setInterval(function () {
        if (dataList.length == 0) {
            return;
        }
        data = dataList.shift()
        createCanvas(data);
    }, 1000);
</script>

</body>
</html>
