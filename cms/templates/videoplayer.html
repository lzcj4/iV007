<html>
<head>
    <meta name="viewport" content="width=device-width">
    {% load static %}
    <script src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
    <script src="{% static 'js/socket.io.js' %}"></script>
    <script src="{% static 'js/VideoFrame.js' %}"></script>
    <script src="{% static 'js/RectDraw.js' %}"></script>
    <style>
        canvas {
            border: 1px solid transparent;
            position: absolute;
        }
    </style>
</head>

<body>

<div style="position:relative;left:10%;top:10%">

    <div id="divCanvas"
         style="position:absolute;left:0;top:0;z-index: 10;width: 1280px;height: 720px;">
        <div style="position:relative;left:40%;top:40%">
            <h2>Loading</h2>
        </div>
    </div>

    <div style="position:absolute;top:0;left:0; ">
        <video id="videoplayer1" autoplay
               style="position:absolute;top:0;left:0; width: 1280px;height: 720px;z-index: 1 ">
            {#            <source src="{% static 'video/test1.mp4' %}" type="video/mp4">#}
        </video>

        <video id="videoplayer2" autoplay
               style="position:absolute;top:0;left:0; width: 1280px;height: 720px;z-index: 0 ">
        </video>
    </div>

</div>

<script>
    'use strict';
    var canvasDict = new Dictionary();
    var layerDict = new Dictionary();
    var dataList = new Array();
    const videoFrameRate = 25;
    var videoFrame1 = new VideoFrame({id: "videoplayer1", frameRate: videoFrameRate});
    var videoFrame2 = new VideoFrame({id: "videoplayer1", frameRate: videoFrameRate});
    var videoPlayer1 = document.getElementById("videoplayer1");
    var videoPlayer2 = document.getElementById("videoplayer2");

    function DescObject(props) {
        this.desckey = props ? props.desckey : "";
        this.descvalue = props ? props.descvalue : "";
    }

    function RectObject(props) {
        if (!props) {
            return;
        }
        this.x = props.x;
        this.y = props.y;
        this.width = props.width;
        this.height = props.height;
        this.objid = props.objid;
        this.objtype = props.objtype;
        this.drawcolor = props.drawcolor;
        this.descs = new Array();
        for (var item of props.descs) {
            this.descs.push(new DescObject(item));
        }
    }

    function TimeObject(props) {
        if (!props) {
            return;
        }
        this.time = props.time;
        this.objects = new Array();
        for (var item of props.objects) {
            this.objects.push(new RectObject(item));
        }
        this.get = function (index) {
            if (index >= 0 && index < this.objects.length) {
                return this.objects[index];
            }
            return null;
        }
    }

    function scaleXByVideo(videoPlayer, x) {
        var result = x / videoPlayer.videoWidth * videoPlayer.clientWidth;
        //result = Math.max(result, 200);
        return result;
    }

    function scaleYByVideo(videoPlayer, y) {
        var result = y / videoPlayer.videoHeight * videoPlayer.clientHeight;
        return result;
    }

    var removeAllDrawObjects = function () {
        $("#divCanvas").empty();
        canvasDict.clear();
    }

    var videoCanPlayCallback = function () {
        removeAllDrawObjects();
    }

    addVidePlayerEvent(videoPlayer1, "canplaythrough", videoCanPlayCallback);
    addVidePlayerEvent(videoPlayer2, "canplaythrough", videoCanPlayCallback);

    var videoPlayCallBack = function (ev) {
        console.log("player:" + ev.target.id + "  duration:" + ev.target.duration +
            " currentTime:" + ev.target.currentTime.toFixed(2));
        drawRectByTime(ev.target.currentTime.toFixed(2));
    }
    addVidePlayerEvent(videoPlayer1, "timeupdate", videoPlayCallBack);
    addVidePlayerEvent(videoPlayer2, "timeupdate", videoPlayCallBack);

    function drawRect(data) {
        var cvs = canvasDict.get(data.name)
        var player = videoPlayer1.style.visibility == "visible" ? videoPlayer1 : videoPlayer2;
        if (cvs != null) {
            cvs.style.left = scaleXByVideo(player, data.x);
            cvs.style.top = scaleYByVideo(player, data.y);
            console.log("---> move rect left:" + cvs.style.left + " top:" + cvs.style.top);
            return;
        }
        var canvas = document.createElement("canvas");
        canvas.width = Math.max(scaleXByVideo(player, item.width), 200);
        canvas.height = Math.max(scaleYByVideo(player, item.height), 200);
        canvas.style.left = scaleXByVideo(player, data.x);
        canvas.style.top = scaleYByVideo(player, data.y);
        canvasDict.put(data.name, canvas);

        $('#divCanvas').append(canvas);
        console.log("++++ add canvas:" + canvas.style.left + " canvas:" + canvas.style.top +
            "width:" + canvas.width + " height:" + canvas.height);
        {#        $("#videoplayer").click(function (ev) {#}
        {#            var pos = mousePosition(ev);#}
        {#            canvas.style.left = pos.x;#}
        {#            canvas.style.top = pos.y;#}
        {#            var num = vf.get();#}
        {#            console.log("current frames:" + num);#}
        {#        })#}
        var ctx = canvas.getContext("2d");
        ctx.strokeStyle = "red";
        ctx.strokeRect(0, 0, 100, 100);
        var img = document.createElement("img");
        img.width = 50;
        img.height = 50;
        img.src = data.icon;
        img.onload = function () {
            ctx.drawImage(img, 110, 0);
        };
        ctx.fillStyle = "red"
        ctx.fillText(data.name, 110, 70);
        ctx.fillText(data.sex, 110, 85);
        ctx.fillText(data.age, 110, 100);
        {#        ctx.fillStyle = "#d3d3d3";#}
        {#        ctx.fillStyle = "green";#}
        {#        ctx.fill();#}
        {##}
        {#        ctx.font = "30px Verdana";#}
        {#        // 创建渐变#}
        {#        var gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);#}
        {#        gradient.addColorStop("0", "magenta");#}
        {#        gradient.addColorStop("0.5", "blue");#}
        {#        gradient.addColorStop("1.0", "red");#}
        {#        // 用渐变填色#}
        {#        ctx.fillStyle = gradient;#}
        {#        ctx.fillText("w3school.com.cn", 10, 90);#}
    }

    function getMaxTextLen(rectObj, ctx) {
        var result = 0;
        if (!(rectObj && ctx)) {
            result = 50;
            return result;
        }

        for (var item of rectObj.descs) {
            var width = ctx.measureText(item.descvalue).width;
            if (width > result) {
                result = width;
            }
        }
        return result;
    }

    function getNearestItem(second) {
        var result = layerDict.get(second);
        if (result == undefined) {
            var i = 0
            var tempKey;
            while (true) {
                tempKey = i++ * 0.25;
                if (tempKey > second) {
                    result = layerDict.get(tempKey);
                    break;
                }
            }
        }
        return result;
    }


    function drawRectByTime(second) {
        removeAllDrawObjects();
        {#        var player = videoPlayer1.style.visibility == "visible" ? videoPlayer1 : videoPlayer2;#}
        var player = videoPlayer1.style.zIndex == 1 ? videoPlayer1 : videoPlayer2;
        var timeObj = getNearestItem(second);
        if (timeObj == undefined) {
            return;
        }
        var i = 1;
        for (var item of timeObj.objects) {
            var cvs = canvasDict.get(item.objid)
            if (cvs != null) {
                cvs.style.left = scaleXByVideo(player, item.x);
                cvs.style.top = scaleYByVideo(player, item.y);
                console.log("---> move rect left:" + cvs.style.left + " top:" + cvs.style.top);
                continue;
            }
            var canvas = document.createElement("canvas");
            var ctx = canvas.getContext("2d");
            var rectWidth = scaleXByVideo(player, item.width);
            var rectHeight = scaleYByVideo(player, item.height);
            var maxTexLen = getMaxTextLen(item, ctx) + 10;
            canvas.width = rectWidth + maxTexLen;
            canvas.height = rectHeight;
            canvas.style.left = scaleXByVideo(player, item.x);
            canvas.style.top = scaleYByVideo(player, item.y);
            canvasDict.put(item.objid, canvas);

            $('#divCanvas').append(canvas);
            console.log("++++ add canvas:" + canvas.style.left + " canvas:" + canvas.style.top +
                "width:" + canvas.width + " height:" + canvas.height);

            ctx.strokeStyle = item.drawcolor;
            ctx.lineWidth = i++;
            ctx.strokeRect(0, 0, rectWidth, rectHeight);
            ctx.fillStyle = item.drawcolor;

            var txtStartX = rectWidth + 10, txtStartY = 10;
            var fontSize = 10;
            for (var desc of item.descs) {
                ctx.fillStyle = "#FF3E4265"
                ctx.fillRect(txtStartX, txtStartY - 10, maxTexLen, parseInt(fontSize, 10) + 3);
                ctx.fillStyle = item.drawcolor;
                ctx.fontSize = fontSize;
                ctx.fillText(desc.descvalue, txtStartX, txtStartY);
                txtStartY += 20;
            }
        }
    }

    //structure data
    var socket = io('http://172.16.4.166:80');
    socket.on('server', function (data) {
        {#        console.log(data);#}
        dataList.push(data);
        layerDict.clear();
        var layerData = data.overlays;
        for (var item of layerData) {
            layerDict.put(item.time, new TimeObject(item));
        }
        socket.emit('client', {my: 'data'});
    });

    {#    setInterval(function () {#}
    {#        if (dataList.length == 0) {#}
    {#            return;#}
    {#        }#}
    {#        var data = dataList.shift();#}
    {#        drawRect(data);#}
    {#    }, 1000);#}

    //video data
    var ws = new WebSocket('ws://172.16.16.88:4589');
    ws.onopen = function () {
        console.log("web socket connected succeed");
        ws.send('startvideo=rtsp://172.16.16.88:4588/vs/rp/A414374375B6/1/1/');
    };

    ws.onerror = function (error) {
        console.log("web socket connected failed" + error);
    };
    ws.onmessage = function (evt) {
        var data = JSON.parse(evt.data);
        if (data.code == "200" && data.filename != null) {

            if (videoPlayer1.src == "") {
                videoPlayer1.src = data.filename;
                return;
            }
            if (!videoPlayer1.paused) {
                videoPlayer2.src = data.filename;
                videoPlayer2.style.zIndex = 1;
                videoPlayer1.style.zIndex = 0;
            } else {
                videoPlayer1.src = data.filename;
                videoPlayer1.style.zIndex = 1;
                videoPlayer2.style.zIndex = 0;
            }
        }
    }
</script>

</body>
</html>
